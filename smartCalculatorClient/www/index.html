<html>
<head>
<meta http-equiv="content-type" content="text/html" />
<meta name="author" content="blog.anchen8.net" />

<title>WEB CAMERA</title>
<script>
var convertBase64ToBlob = function(base64){
    var base64Arr = base64.split(',');
    var imgtype = '';
    var base64String = '';
    if(base64Arr.length > 1){
        //如果是图片base64，去掉头信息
        base64String = base64Arr[1];
        imgtype = base64Arr[0].substring(base64Arr[0].indexOf(':')+1,base64Arr[0].indexOf(';'));
    }
    // 将base64解码
    var bytes = atob(base64String);
    //var bytes = base64;
    var bytesCode = new ArrayBuffer(bytes.length);
     // 转换为类型化数组
    var byteArray = new Uint8Array(bytesCode);
    
    // 将base64转换为ascii码
    for (var i = 0; i < bytes.length; i++) {
        byteArray[i] = bytes.charCodeAt(i);
    }
   
    // 生成Blob对象（文件对象）
    return new Blob( [bytesCode] , {type : imgtype});
};
var socket;
var canvas;  
var context;
function connect_to_server(){
	console.log("connect to server.....\n");
	canvas = document.getElementById("myCanvas");  
	context = canvas.getContext("2d");  
	try{
		socket=new WebSocket('ws://192.168.1.230:8888');
	}catch(e){
		console.log("failed to connect to server!!");
		return;
	}
	socket.onopen = sOpen;
	socket.onerror=sError;
	socket.onmessage=sMessage;
	socket.onclose=sClose

}
function sOpen(){
	console.log("connect to server successfully!\n");
}
function sError(){
	console.log("server error!!");
}
function sMessage(msg){
	console.log("new data has coming...");
	console.log(msg.data);
	var json_data = eval("(" + msg.data+")");
	console.log(json_data);
	var image = new Image();
	image.onload = function()
	{
		context.clearRect(0, 0,canvas.width, canvas.height);  
		context.drawImage(image, 0, 0, canvas.width, canvas.height);  
	}
	//image.src = URL.createObjectURL(json_data.image);
	image.src = json_data.image;
}

function sClose(){
	console.log("server has offline!!\n");
}
function send(){
	socket.send('hello ,i am client!')
}
function close(){
	socket.close();
}

</script>
</head>

<body>

<canvas align="center" id="myCanvas" style="width: 640; height: 480px;" width="640px" height="480px"></canvas> 
<br>
<input id="msg" type="text">
<br>
<button id="connect" onclick="connect_to_server();">Connect</button>
<br>
<button id="send" onclick="send();">Send</button>
<br>
<button id="close" onclick="close();">Close</button>
<br>

</body>

</html>
